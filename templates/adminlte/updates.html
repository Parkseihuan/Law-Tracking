{% extends "adminlte/base.html" %}

{% block title %}변경 이력 - 법령 추적 시스템{% endblock %}
{% block page_title %}변경 이력{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/">홈</a></li>
<li class="breadcrumb-item active">변경 이력</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 필터 카드 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-filter mr-1"></i>
                    필터
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>기간</label>
                            <select class="form-control" id="period-filter" onchange="loadHistory()">
                                <option value="7">최근 7일</option>
                                <option value="30">최근 30일</option>
                                <option value="90">최근 90일</option>
                                <option value="0">전체</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>법령</label>
                            <select class="form-control" id="law-filter" onchange="loadHistory()">
                                <option value="">전체 법령</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>변경 유형</label>
                            <select class="form-control" id="type-filter" onchange="loadHistory()">
                                <option value="">전체</option>
                                <option value="신규">신규</option>
                                <option value="개정">개정</option>
                                <option value="폐지">폐지</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 변경 이력 타임라인 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history mr-1"></i>
                    변경 이력
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" onclick="loadHistory()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" id="history-timeline">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-3x text-muted"></i>
                    <p class="mt-3 text-muted">데이터 로딩 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline {
    position: relative;
    margin: 0 0 30px 0;
    padding: 0;
    list-style: none;
}

.timeline:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #ddd;
    left: 31px;
    margin: 0;
}

.timeline > li {
    position: relative;
    margin-right: 10px;
    margin-bottom: 15px;
}

.timeline > li:before,
.timeline > li:after {
    content: " ";
    display: table;
}

.timeline > li:after {
    clear: both;
}

.timeline > li > .timeline-item {
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    border-radius: 3px;
    margin-top: 0;
    background: #fff;
    color: #444;
    margin-left: 60px;
    margin-right: 15px;
    padding: 0;
    position: relative;
}

.timeline > li > .timeline-item > .time {
    color: #999;
    float: right;
    padding: 10px;
    font-size: 12px;
}

.timeline > li > .timeline-item > .timeline-header {
    margin: 0;
    color: #555;
    border-bottom: 1px solid #f4f4f4;
    padding: 10px;
    font-size: 16px;
    line-height: 1.1;
}

.timeline > li > .timeline-item > .timeline-body,
.timeline > li > .timeline-item > .timeline-footer {
    padding: 10px;
}

.timeline > li > .fa,
.timeline > li > .fas,
.timeline > li > .far,
.timeline > li > .fab,
.timeline > li > .glyphicon,
.timeline > li > .ion {
    width: 30px;
    height: 30px;
    font-size: 15px;
    line-height: 30px;
    position: absolute;
    color: #666;
    background: #d2d6de;
    border-radius: 50%;
    text-align: center;
    left: 18px;
    top: 0;
}

.timeline > .time-label > span {
    font-weight: 600;
    padding: 5px;
    display: inline-block;
    background-color: #fff;
    border-radius: 4px;
}

.timeline-inverse > li > .timeline-item {
    background: #f0f0f0;
    border: 1px solid #ddd;
    box-shadow: none;
}

.bg-update {
    background-color: #f39c12 !important;
}

.bg-new {
    background-color: #00a65a !important;
}

.bg-delete {
    background-color: #dd4b39 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let allHistory = [];

// 페이지 로드 시 실행
$(document).ready(function() {
    loadLawsForFilter();
    loadHistory();
});

// 필터용 법령 목록 로드
function loadLawsForFilter() {
    fetch('/api/laws')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('law-filter');
            data.forEach(law => {
                const option = document.createElement('option');
                option.value = law.법령명;
                option.textContent = law.법령명;
                select.appendChild(option);
            });
        })
        .catch(err => console.error('법령 목록 로드 실패:', err));
}

// 변경 이력 로드
function loadHistory() {
    const timeline = document.getElementById('history-timeline');

    fetch('/api/laws')
        .then(response => response.json())
        .then(data => {
            // 모든 법령의 변경 이력을 수집
            allHistory = [];

            data.forEach(law => {
                if (law.변경내역 && law.변경내역.length > 0) {
                    law.변경내역.forEach(change => {
                        allHistory.push({
                            법령명: law.법령명,
                            확인시각: change.확인시각,
                            변경내용: change.변경내용 || '내용 확인 중',
                            이전공포일자: change.이전공포일자,
                            현재공포일자: change.현재공포일자,
                            타입: change.타입 || '개정'
                        });
                    });
                }
            });

            // 필터 적용
            const filtered = applyFilters(allHistory);

            // 타임라인 렌더링
            renderTimeline(filtered);
        })
        .catch(err => {
            console.error('이력 로드 실패:', err);
            timeline.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    변경 이력을 불러올 수 없습니다.
                </div>
            `;
        });
}

// 필터 적용
function applyFilters(history) {
    const period = parseInt(document.getElementById('period-filter').value);
    const lawFilter = document.getElementById('law-filter').value;
    const typeFilter = document.getElementById('type-filter').value;

    let filtered = [...history];

    // 기간 필터
    if (period > 0) {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - period);

        filtered = filtered.filter(item => {
            const itemDate = new Date(item.확인시각);
            return itemDate >= cutoffDate;
        });
    }

    // 법령 필터
    if (lawFilter) {
        filtered = filtered.filter(item => item.법령명 === lawFilter);
    }

    // 타입 필터
    if (typeFilter) {
        filtered = filtered.filter(item => item.타입 === typeFilter);
    }

    // 최신순 정렬
    filtered.sort((a, b) => new Date(b.확인시각) - new Date(a.확인시각));

    return filtered;
}

// 타임라인 렌더링
function renderTimeline(history) {
    const timeline = document.getElementById('history-timeline');

    if (history.length === 0) {
        timeline.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                조건에 맞는 변경 이력이 없습니다.
            </div>
        `;
        return;
    }

    // 날짜별로 그룹화
    const groupedByDate = {};
    history.forEach(item => {
        const date = new Date(item.확인시각).toLocaleDateString('ko-KR');
        if (!groupedByDate[date]) {
            groupedByDate[date] = [];
        }
        groupedByDate[date].push(item);
    });

    let html = '<ul class="timeline">';

    // 날짜별로 렌더링
    Object.keys(groupedByDate).forEach(date => {
        // 날짜 라벨
        html += `
            <li class="time-label">
                <span class="bg-primary">${date}</span>
            </li>
        `;

        // 해당 날짜의 이력들
        groupedByDate[date].forEach(item => {
            const iconClass = getIconClass(item.타입);
            const bgClass = getBgClass(item.타입);
            const time = new Date(item.확인시각).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            html += `
                <li>
                    <i class="fas ${iconClass} ${bgClass}"></i>
                    <div class="timeline-item">
                        <span class="time"><i class="fas fa-clock"></i> ${time}</span>
                        <h3 class="timeline-header">
                            <strong>${item.법령명}</strong>
                            <span class="badge badge-${getTypeBadgeClass(item.타입)} ml-2">${item.타입}</span>
                        </h3>
                        <div class="timeline-body">
                            ${item.변경내용}
                        </div>
                        <div class="timeline-footer">
                            <small class="text-muted">
                                ${item.이전공포일자 ? `이전: ${item.이전공포일자}` : ''}
                                ${item.현재공포일자 ? `→ 현재: ${item.현재공포일자}` : ''}
                            </small>
                        </div>
                    </div>
                </li>
            `;
        });
    });

    html += `
        <li>
            <i class="fas fa-clock bg-gray"></i>
        </li>
    </ul>`;

    timeline.innerHTML = html;
}

// 타입에 따른 아이콘
function getIconClass(type) {
    switch(type) {
        case '신규': return 'fa-plus';
        case '개정': return 'fa-edit';
        case '폐지': return 'fa-trash';
        default: return 'fa-file-alt';
    }
}

// 타입에 따른 배경색
function getBgClass(type) {
    switch(type) {
        case '신규': return 'bg-new';
        case '개정': return 'bg-update';
        case '폐지': return 'bg-delete';
        default: return 'bg-primary';
    }
}

// 타입에 따른 배지 색상
function getTypeBadgeClass(type) {
    switch(type) {
        case '신규': return 'success';
        case '개정': return 'warning';
        case '폐지': return 'danger';
        default: return 'info';
    }
}
</script>
{% endblock %}
