{% extends "adminlte/base.html" %}

{% block title %}법령 목록 - 법령 추적 시스템{% endblock %}
{% block page_title %}법령 목록{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/">홈</a></li>
<li class="breadcrumb-item active">법령 목록</li>
{% endblock %}

{% block extra_css %}
<style>
    table.dataTable {
        border-bottom: 1px solid #dee2e6 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">추적 중인 법령</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addLawModal">
                        <i class="fas fa-plus"></i> 법령 추가
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table id="laws-table" class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>법령명</th>
                            <th>법령 종류</th>
                            <th>공포일자</th>
                            <th>변경횟수</th>
                            <th>마지막 확인</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if laws %}
                        {% for law_name, law_info in laws.items() %}
                        <tr>
                            <td>
                                <strong>{{ law_name }}</strong>
                                {% if law_info.get('변경횟수', 0) > 0 %}
                                <span class="badge badge-warning ml-2 update-badge">업데이트</span>
                                {% endif %}
                            </td>
                            <td>{{ law_info.get('법령종류명', '-') }}</td>
                            <td>{{ law_info.get('공포일자', '-') }}</td>
                            <td>
                                {% if law_info.get('변경횟수', 0) > 0 %}
                                <span class="badge badge-danger">{{ law_info['변경횟수'] }}건</span>
                                {% else %}
                                <span class="badge badge-success">0건</span>
                                {% endif %}
                            </td>
                            <td>{{ law_info.get('마지막확인', '-') }}</td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="viewLawDetail('{{ law_name }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="removeLaw('{{ law_name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">추적 중인 법령이 없습니다</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 법령 추가 모달 -->
<div class="modal fade" id="addLawModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">법령 추가</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addLawForm">
                    <div class="form-group">
                        <label for="lawName">법령명</label>
                        <input type="text" class="form-control" id="lawName" placeholder="예: 사립학교법" required>
                        <small class="form-text text-muted">추적할 법령의 이름을 입력하세요</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="addLaw()">추가</button>
            </div>
        </div>
    </div>
</div>

<!-- 법령 상세 모달 -->
<div class="modal fade" id="lawDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lawDetailTitle">법령 상세</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="lawDetailBody">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p class="mt-3">로딩 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        $('#laws-table').DataTable({
            "paging": true,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
            "language": {
                "lengthMenu": "_MENU_ 건씩 보기",
                "zeroRecords": "검색 결과가 없습니다",
                "info": "_START_-_END_ / _TOTAL_건",
                "infoEmpty": "데이터 없음",
                "infoFiltered": "(전체 _MAX_건 중 검색)",
                "search": "검색:",
                "paginate": {
                    "first": "처음",
                    "last": "마지막",
                    "next": "다음",
                    "previous": "이전"
                }
            }
        });
    });

    function addLaw() {
        const lawName = document.getElementById('lawName').value.trim();

        if (!lawName) {
            alert('법령명을 입력해주세요');
            return;
        }

        fetch('/api/add-law', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ law_name: lawName })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('법령이 추가되었습니다');
                    location.reload();
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(err => {
                console.error('법령 추가 실패:', err);
                alert('법령 추가 중 오류가 발생했습니다');
            });
    }

    function removeLaw(lawName) {
        if (!confirm(`"${lawName}"를 삭제하시겠습니까?`)) {
            return;
        }

        fetch('/api/remove-law', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ law_name: lawName })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('법령이 삭제되었습니다');
                    location.reload();
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(err => {
                console.error('법령 삭제 실패:', err);
                alert('법령 삭제 중 오류가 발생했습니다');
            });
    }

    function viewLawDetail(lawName) {
        $('#lawDetailTitle').text(lawName);
        $('#lawDetailModal').modal('show');

        fetch(`/api/law-detail?name=${encodeURIComponent(lawName)}`)
            .then(response => response.json())
            .then(data => {
                const html = `
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">법령명</dt>
                        <dd class="col-sm-8">${data.법령명}</dd>
                        <dt class="col-sm-4">법령 종류</dt>
                        <dd class="col-sm-8">${data.법령종류명 || '-'}</dd>
                        <dt class="col-sm-4">공포일자</dt>
                        <dd class="col-sm-8">${data.공포일자 || '-'}</dd>
                        <dt class="col-sm-4">시행일자</dt>
                        <dd class="col-sm-8">${data.시행일자 || '-'}</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">소관부처</dt>
                        <dd class="col-sm-8">${data.소관부처명 || '-'}</dd>
                        <dt class="col-sm-4">변경횟수</dt>
                        <dd class="col-sm-8"><span class="badge ${data.변경횟수 > 0 ? 'badge-danger' : 'badge-success'}">${data.변경횟수 || 0}건</span></dd>
                        <dt class="col-sm-4">마지막 확인</dt>
                        <dd class="col-sm-8">${data.마지막확인 || '-'}</dd>
                    </dl>
                </div>
            </div>
            ${data.변경내역 && data.변경내역.length > 0 ? `
            <hr>
            <h6>변경 이력</h6>
            <ul class="list-group">
                ${data.변경내역.slice(0, 5).map(change => `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${change.확인시각}</strong><br>
                                ${change.변경내용 || '내용 확인 중'}
                            </div>
                            ${change.신구대조표 ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="window.open('/api/law-diff?filename=${change.신구대조표}', '_blank', 'width=1200,height=800')">
                                <i class="fas fa-exchange-alt"></i> 변경 내용 보기
                            </button>
                            ` : ''}
                        </div>
                    </li>
                `).join('')}
            </ul>
            ` : ''}
        `;
                $('#lawDetailBody').html(html);
            })
            .catch(err => {
                console.error('법령 상세 로드 실패:', err);
                $('#lawDetailBody').html('<div class="alert alert-danger">데이터를 불러올 수 없습니다</div>');
            });
    }
</script>
{% endblock %}